(globalThis["webpackChunk_openeo_web_editor"]=globalThis["webpackChunk_openeo_web_editor"]||[]).push([[8945],{68945:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>z});var i=function(){var e=this,t=e._self._c;return t("div",{ref:"div",class:e.classes,attrs:{id:e.id,tabindex:"0"},on:{mousemove:e.onMouseMove,mousedown:e.onMouseDown,wheel:e.onMouseWheel,keydown:e.onKeyDown,focus:function(t){e.hasFocus=!0},blur:function(t){e.hasFocus=!1}}},[t("svg",{staticClass:"canvas",attrs:{xmlns:"http://www.w3.org/2000/svg",version:"1.1"}},[e._l(e.edges,(function(s){return t("Edge",{key:s.id,attrs:{id:s.id,parameter1:s.parameter1,parameter2:s.parameter2,selected:s.selected,inactive:s.inactive,issues:s.issues,state:e.state},on:{mounted:t=>e.mount(s,t),unmounted:()=>e.mount(s),position:function(t){return e.updateEdgePos(s,arguments)}}})})),e._l(e.hiddenParameterRefEdges,(function(s){return t("Edge",{key:s.id,attrs:{id:s.id,parameter1:s.parameter1,parameter2:s.parameter2,inactive:!0,lineColor:[200,200,200,1],lineWidth:2,state:e.state},on:{mounted:t=>e.mount(s,t),unmounted:()=>e.mount(s)}})})),e.linkingLine?t("line",e._b({},"line",e.linkingLine,!1)):e._e(),e.selectRect?t("rect",e._b({},"rect",e.selectRect,!1)):e._e()],2),t("div",{staticClass:"blocks"},e._l(e.blocks,(function(s){return t("Block",{key:s.id,attrs:{id:s.id,type:s.type,spec:s.spec,state:e.state,selected:s.selected,position:s.position,origin:s.origin,process_id:s.process_id,namespace:s.namespace,result:s.result,args:s.arguments,description:s.description},on:{update:(...t)=>e.updateBlock(s,...t),mounted:t=>e.mount(s,t),unmounted:()=>e.mount(s),move:e.startDragBlock}})})),1),e.state.scale<.7||e.showZoomInfo?t("div",{staticClass:"zoomInfo"},[e.state.scale<.7?t("div",[e._v(" Zoom in for more details. ")]):e._e(),e.showZoomInfo?t("div",[e._v(" Zoom with "),t("kbd",[e._v("STRG")]),e._v(" or "),t("kbd",[e._v("Meta")]),e._v(" key and the mouse wheel. ")]):e._e()]):e._e(),e.parameterViewer?t("ParameterViewer",e._b({on:{close:function(t){e.parameterViewer=null}}},"ParameterViewer",e.parameterViewer,!1)):e._e()],1)},r=[],a=function(){var e=this,t=e._self._c;return t("div",{ref:"div",class:e.containerClasses,style:e.styles,attrs:{id:"block"+this.id},on:{mousedown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"left",37,t.key,["Left","ArrowLeft"])?null:(t.preventDefault(),t.stopPropagation(),"button"in t&&0!==t.button?null:e.onMouseDown.apply(null,arguments))}}},[t("div",{staticClass:"blockTitle",on:{mousedown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"left",37,t.key,["Left","ArrowLeft"])?null:(t.preventDefault(),t.stopPropagation(),"button"in t&&0!==t.button?null:e.emitDrag.apply(null,arguments))}}},[t("span",{staticClass:"titleText",attrs:{title:e.plainTitle}},[t("span",{directives:[{name:"show",rawName:"v-show",value:e.invalid,expression:"invalid"}],staticClass:"invalid",attrs:{title:"Process or Collection not supported!"}},[t("i",{staticClass:"fas fa-exclamation-triangle"})]),e._v(" "+e._s(e.name)+" "),e.showId?t("span",{staticClass:"blockId"},[e._v(e._s(e.id))]):e._e()]),t("div",{staticClass:"blockicon",on:{mousedown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"left",37,t.key,["Left","ArrowLeft"])?null:(t.preventDefault(),t.stopPropagation(),"button"in t&&0!==t.button?null:e.focus())}}},[t("span",{directives:[{name:"show",rawName:"v-show",value:e.allowsDescription&&!e.showDescriptionField,expression:"allowsDescription && !showDescriptionField"}],staticClass:"addDescription",attrs:{title:"Add description"},on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.addDescription()}}},[t("i",{staticClass:"fas fa-comment-medical"})]),t("span",{directives:[{name:"show",rawName:"v-show",value:e.allowsDelete,expression:"allowsDelete"}],staticClass:"delete",attrs:{title:"Remove (DEL)"},on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.remove()}}},[t("i",{staticClass:"fas fa-trash"})]),t("span",{directives:[{name:"show",rawName:"v-show",value:e.allowsInfo,expression:"allowsInfo"}],staticClass:"info",attrs:{title:"Details"},on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.showInfo()}}},[t("i",{staticClass:"fas fa-info"})]),t("span",{directives:[{name:"show",rawName:"v-show",value:e.allowsParameterChange,expression:"allowsParameterChange"}],staticClass:"settings",attrs:{title:e.isParameter?"Edit parameter":"Change parameter values"},on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.edit.apply(null,arguments)}}},[t("i",{staticClass:"fas fa-edit"})])])]),t("div",{staticClass:"inout"},[t("div",{staticClass:"inputs"},e._l(e.parameters,(function(s,i){return t("BlockParameter",{key:i,ref:"parameters",refInFor:!0,attrs:{state:e.state,value:e.args[s.name],name:s.name,description:s.description,optional:s.optional,deprecated:s.deprecated,experimental:s.experimental,default:s.default,schema:s.schema},on:{input:t=>e.updateArgument(s.name,t),edgesChanged:function(t){return e.edgesChanged(s,t)}}})})),1),t("div",{staticClass:"outputs"},[t("BlockParameter",e._b({ref:"output",attrs:{state:e.state,label:e.outputLabel},on:{input:e.updateResult}},"BlockParameter",e.output,!1))],1)]),e.showDescriptionField?t("textarea",{ref:"descriptionField",staticClass:"editDescription",attrs:{readonly:!e.state.editable,placeholder:"Type description here..."},domProps:{value:e.description},on:{blur:e.updateDescription,mousedown:function(e){e.stopPropagation()}}}):e._e()])},o=[],n=function(){var e=this,t=e._self._c;return t("div",{class:e.classes},[e.output?e._e():t("div",e._g({ref:"circle",class:e.circleClasses},e.circleListeners)),t("span",e._g({staticClass:"text"},e.textListeners),[t("span",{directives:[{name:"show",rawName:"v-show",value:e.unspecified,expression:"unspecified"}],staticClass:"unspecified",attrs:{title:"Parameter is likely unsupported!"}},[t("i",{staticClass:"fas fa-exclamation-triangle"})]),t("span",{staticClass:"label"},[e._v(e._s(e.displayLabel))]),e.displayValue.length?[e._v(": ")]:e._e(),t("span",{staticClass:"value",domProps:{innerHTML:e._s(e.displayValue)}})],2),e.output?t("div",e._g({ref:"circle",class:e.circleClasses,attrs:{title:"Output of the process"}},e.circleListeners)):e._e()])},l=[],h=s(52590),c=s(28954),u=s(65973),p=s(25108);const d={name:"BlockParameter",props:{name:{type:String,default:"output"},description:{type:String,default:""},optional:{type:Boolean,default:!1},deprecated:{type:Boolean,default:!1},experimental:{type:Boolean,default:!1},default:{},value:{},schema:{type:[Object,Array],default:null},label:{type:String},output:{type:Boolean,default:!1},state:{type:Object,required:!0}},data(){return{edges:[]}},computed:{schemas(){return this.schema instanceof h.ProcessSchema?this.schema:new h.ProcessSchema(this.schema)},hasValue(){return void 0!==this.value},textListeners(){return this.allowsArgumentChange?{click:this.openEditorForArguments}:{}},circleListeners(){var e={};return this.state.editable&&(e.mousedown=e=>{1==e.which&&(this.state.root.link(this),e.preventDefault(),e.stopPropagation())},this.output&&(e.dblclick=e=>{1==e.which&&this.$emit("input",!0)}),e.mouseover=()=>this.state.linkFrom&&this.state.root.link(this),e.mouseout=()=>this.state.linkTo&&this.state.root.unlink(this)),e},classes(){let e=[this.output?"output":"input","connector","field_"+this.name,this.hasValue||this.optional||this.output||this.getEdgeCount()>0?"hasValue":"noValue"];return this.allowsArgumentChange&&e.push("editable"),e},unspecified(){return!this.$parent.invalid&&this.state.root.hasProcesses&&this.schemas.unspecified},circleClasses(){var e=["circle"];for(var t of(this.getEdgeCount()>0&&e.push("io_active"),this.edges))t.selected?e.push("io_selected"):t.issues.length>0&&e.push("io_issues");return this.state.linkFrom!=this&&this.state.linkTo!=this||e.push("io_selected"),e},displayValue(){var e=38-this.displayLabel.length,t=null;if(this.isEditable&&!this.state.compactMode&&!u.Z.isRef(this.value)){let s="undefined"!==typeof this.value?this.value:this.default;"undefined"!==typeof s&&(t=this.formatValue(s,e,!0))}return"string"===typeof t?0===t.length&&(t="<em>Empty</em>"):t="",t},displayLabel(){return this.output&&this.state.compactMode?"":"string"===typeof this.label&&(this.label.length>0||this.output)?this.label:this.name},isArrayType(){return"array"===this.schemas.nativeDataType()},isObjectType(){return"object"===this.schemas.nativeDataType()},isEditable(){return!this.output&&this.schemas.isEditable()},allowsArgumentChange(){return!this.output&&this.schemas.isEditable()},allowsMultipleInputs(){return this.isArrayType||this.isObjectType||"any"===this.schemas.nativeDataType()}},watch:{edges(){this.updateEdgeStatus(),this.$emit("edgesChanged",this.edges,this)},value:{immediate:!0,handler(){this.updateEdgeStatus()}}},methods:{updateEdgeStatus(){if(!this.output)for(var e of this.edges)e.inactive=!this.isEdgeUsed(e)},getCirclePosition(){try{var e=this.state.root.domBoundingBox(this.$refs.circle),t=this.state.root.getDimensions(),s=e.offsetLeft-t.offsetLeft+e.width/2,i=e.offsetTop-t.offsetTop+e.height/2;return[s,i]}catch(r){return p.warn(r),null}},openEditorForArguments(){this.allowsArgumentChange&&this.$parent.showArguments(this.name)},jsonSchema(){return this.schemas.toJSON()},setValue(e){"boolean"!=this.schemas.nativeDataType()||u.Z.isRef(e)||(e=!!e),this.$emit("input",e)},resetValue(){if("undefined"===typeof this.default){var e;if(this.schemas.nullable())e=null;else{var t=this.schemas.nativeDataType();switch(t){case"object":e={};break;case"array":e=[];break;case"string":e="";break;case"integer":case"number":e=0;break;case"boolean":e=!1;break;default:e=void 0}}this.setValue(e)}else this.setValue(this.default)},getEdgeRef(e){return this.output?this.value:e.parameter1.value},addRefToValue(e){var t=this.getEdgeRef(e);if(t)if(this.allowsMultipleInputs)if(this.isArrayType)if(u.Z.isRef(this.value))this.setValue([this.value,t]);else if(Array.isArray(this.value)&&this.value.length>0){var s=this.value;s.push(t),this.setValue(s)}else this.setValue(t);else if(this.isObjectType){var i=u.Z.size(this.value);1!==this.getEdgeCount()||this.hasValue&&i?i||this.resetValue():this.setValue(t)}else this.setValue(t);else this.setValue(t)},removeRefFromValue(e){if(!this.output){var t=this.getEdgeRef(e);u.Z.isRefEqual(t,this.value)?this.resetValue():(this.isArrayType||this.isObjectType)&&this.setValue(this.removeRefFromValueDeep(this.value,t))}},removeRefFromValueDeep(e,t){if(Array.isArray(e)){var s=e.length;while(--s>=0)null!==e[s]&&"object"===typeof e[s]&&(u.Z.isRefEqual(t,e[s])?e.splice(s,1):e[s]=this.removeRefFromValueDeep(e[s],t))}else if(u.Z.isObject(e))for(var i in e)e.hasOwnProperty(i)&&null!==e[i]&&"object"===typeof e[i]&&(u.Z.isRefEqual(t,e[i])?delete e[i]:e[s]=this.removeRefFromValueDeep(e[i],t));return e},addEdge(e){this.edges.push(e),this.isEdgeUsed(e)||this.output||this.addRefToValue(e)},eraseEdge(e){for(var t in this.edges)if(this.edges[t]==e)return this.removeRefFromValue(e),this.$delete(this.edges,t),!0;return!1},isEdgeUsed(e){var t=this.getEdgeRef(e);return!!u.Z.isRefEqual(t,this.value)||this.hasRefInValue(t,this.value)},hasRefInValue(e,t){if(!t||"object"!==typeof t)return!1;if(u.Z.isRefEqual(e,t))return!0;for(let s in t)if(this.hasRefInValue(e,t[s]))return!0;return!1},getEdgeCount(){return this.edges.length},formatProcess(e,t){if(e instanceof c.ProcessGraph&&1===e.getNodeCount())return this.formatValue(e.getResultNode().process_id,t);var s=Object.values(e.process_graph);return 1===s.length?this.formatValue(s[0].process_id,t):"Process"},formatValue(e,t,s=!0){if("object"===typeof e)return null===e?"n/a":Array.isArray(e)?this.formatArray(e,t,s):this.formatObject(e,t,s);if("string"===typeof e){if(e.length>t){var i=u.Z.htmlentities(e.substr(0,t));return s?i+'<span title="'+u.Z.htmlentities(e)+'">…</span>':i}return u.Z.htmlentities(e)}return"boolean"===typeof e?e?"✔️":"❌":"number"===typeof e?e.toString():u.Z.htmlentities(JSON.stringify(e))},formatArray(e,t,s=!0){let i=[];for(let r in e){let a=e[r],o=this.formatValue(a,10,s),n=u.Z.htmlentities_decode(this.formatValue(a,10,!1));if(n.length>t){if(0===i.length)return this.formatArraySimple(e,"List("+e.length+")");i.push(this.formatArraySimple(e,"…"));break}i.push(o),t-=n.length+2}return i.join(", ")},formatArraySimple(e,t,s=!0){if(s&&e.length<10){let s=e.map((e=>this.formatValue(e,25,!1))).join(", ");return'<span title="'+s+'">'+t+"</span>"}return t},formatObject(e,t,s=!0){return 0===Object.keys(e).length?"None":e instanceof c.ProcessGraph||u.Z.isObject(e.process_graph)?this.formatProcess(e,t):u.Z.isRef(e)?this.formatValue(u.Z.formatRef(e),t):"undefined"!==typeof e.west&&"undefined"!==typeof e.east&&"undefined"!==typeof e.south&&"undefined"!==typeof e.north?t>=12?"Bounding Box":"BBox":u.Z.detectGeoJson(e)?this.formatValue(e.type,t):s?'<span title="'+u.Z.htmlentities(JSON.stringify(e))+'">Object</span>':"Object"}}},m=d;var f=s(1001),g=(0,f.Z)(m,n,l,!1,null,null,null);const y=g.exports,v={defaultScale:1.3,blockWidth:{compactParams:110,compact:60,normalParams:220,normal:110}},b=10,k={name:"Block",components:{BlockParameter:y},props:{id:{type:String,required:!0},type:{type:String,required:!0},selected:{type:Boolean,default:!1},position:{type:Array,required:!0},process_id:{type:String},namespace:{type:String,default:null},description:{type:String,default:null},args:{type:Object,default:()=>({})},result:{type:Boolean,default:!1},origin:{type:String,default:null},spec:{type:Object,default:()=>null},state:{type:Object,required:!0}},data(){return{showDescriptionField:!1,drag:null}},watch:{"state.compactMode"(){this.$emit("moved",this.position)},description:{immediate:!0,handler(){this.showDescriptionField=null!==this.description}}},computed:{width(){let e=v.blockWidth;return this.parameters.length>0?this.state.compactMode?e.compactParams:e.normalParams:this.state.compactMode?e.compact:e.normal},styles(){return{marginLeft:Math.round(this.state.center[0]+this.position[0]*this.state.scale)+"px",marginTop:Math.round(this.state.center[1]+this.position[1]*this.state.scale)+"px",fontSize:Math.round(this.state.scale*b)+"px",width:Math.round(this.state.scale*this.width)+"px"}},plainTitle(){let e=[];return e.push(this.name),this.namespace&&e.push(`@${this.namespace}`),this.showId&&e.push(` ${this.id}`),e.join("")},name(){switch(this.type){case"process":return this.collectionId?this.collectionId:this.processId;case"parameter":return this.spec.name;default:return this.id.substr(1)}},outputLabel(){return this.result?"Result":this.isParameter?"Process Parameter":""},containerClasses(){var e=["block"];return this.collectionId?e.push("block_collection"):this.isParameter&&e.push("block_argument"),this.result&&e.push("block_result"),this.selected&&e.push("block_selected"),this.invalid&&e.push("block_invalid"),e},invalid(){if("process"!==this.type||!this.$parent.hasProcesses)return!1;if(this.namespace&&u.Z.isUrl(this.namespace))return!1;if(!this.processId)return!0;if(!this.spec)return!0;if("load_collection"===this.processId&&!u.Z.isRef(this.args.id)){for(let e of this.$parent.collections)if(this.args.id===e.id)return!1;return!0}return!1},processId(){if("process"===this.type){if(this.process_id)return this.process_id;if(u.Z.isObject(this.spec)&&this.spec.id)return this.spec.id}return null},collectionId(){return"process"!==this.type||"load_collection"!==this.processId||u.Z.isRef(this.args.id)?null:this.args.id},isParameter(){return"parameter"===this.type},allowsParameterChange(){return this.isParameter?this.state.editable&&!!this.$parent.supports("editParameter"):this.parameters.filter((e=>e.isEditable())).length>0},allowsDelete(){return this.state.editable&&(!this.spec||u.Z.isObject(this.spec)&&"schema"!==this.origin)},allowsInfo(){return this.collectionId?this.$parent.supports("showCollection"):this.isParameter?u.Z.isObject(this.spec)&&this.$parent.supports("showParameter"):this.$parent.supports("showProcess")},allowsDescription(){return this.state.editable&&"process"===this.type},showId(){return"parameter"!==this.type},hasParametersDefined(){return Boolean(u.Z.isObject(this.spec)&&Array.isArray(this.spec.parameters)&&this.spec.parameters.length>0)},parameters(){let e=[],t=[];if(this.hasParametersDefined&&(t=this.spec.parameters.map((e=>new h.ProcessParameter(e))),e=t.map((e=>e.name))),u.Z.size(this.args)>0)for(var s in this.args)e.includes(s)||t.push(new h.ProcessParameter({name:s,description:""}));return t},fields(){var e={};for(var t of this.parameters)e[t.name]=t;return e.output=this.output,e},output(){var e={};u.Z.isObject(this.spec)&&(this.isParameter?e=this.spec:u.Z.isObject(this.spec.returns)&&(e=this.spec.returns));var t={name:"output",schema:e.schema||{},description:e.description||"",optional:!0,output:!0,value:{}};return this.isParameter?t.value.from_parameter=this.id.substr(1):t.value.from_node=this.id.substr(1),t}},mounted(){this.draggingFn=this.dragging.bind(this),document.addEventListener("mousemove",this.draggingFn),this.stopDragFn=this.stopDrag.bind(this),document.addEventListener("mouseup",this.stopDragFn),this.$emit("mounted",this)},beforeDestroy(){document.removeEventListener("mousemove",this.draggingFn),document.removeEventListener("mouseup",this.stopDragFn),this.$emit("unmounted",this)},methods:{edit(){this.isParameter?this.editParameter():this.showArguments()},hasParameter(e){return this.hasParametersDefined&&!!this.spec.parameters.find((t=>t.name===e))},updateDescription(e){let t,s=e.composedPath()[0];t=s&&"string"===typeof s.value&&s.value.length>0?s.value:null,this.showDescriptionField=null!==t,this.description!==t&&this.$emit("update","description",t)},updatePosition(e,t=!0){e=u.Z.ensurePoint(e),this.position[0]===e[0]&&this.position[1]===e[1]||this.$emit("update","position",e,t)},updateArguments(e){let t=Object.keys(this.args).filter((t=>"undefined"===typeof e[t]&&(!this.hasParametersDefined||this.hasParameter(t))));for(let s of this.parameters)"undefined"!==typeof e[s.name]&&s.optional&&"undefined"!==typeof s.default&&u.Z.equals(s.default,e[s.name])&&delete e[s.name];this.$emit("update","arguments",e,t)},updateArgument(e,t){let s=u.Z.deepClone(this.args);s[e]=t,this.updateArguments(s)},updateResult(e){this.hasOutputEdges()?this.state.root.$emit("error","A result node can't have outgoing edges."):e!==this.result&&this.$emit("update","result",e)},focus(){this.$parent.focus()},onMouseDown(e){this.select(!this.selected,!e.shiftKey)},select(e=!0,t=!0){this.$emit("update","selected",e,t),this.focus()},getDimensions(){let e=this.$parent.domBoundingBox(this.$refs.div);var t=this.$parent.getDimensions();return e.x=e.offsetLeft-t.offsetLeft,e.y=e.offsetTop-t.offsetTop,e},edgesChanged(e,t){e.refs=t.map((e=>e.parameter1.value))},editParameter(){this.$parent.$emit("editParameter",this.spec,"Edit Parameter: "+this.plainTitle,(e=>this.$emit("update","spec",e)))},showArguments(e=null){this.$parent.$emit("editArguments",this.parameters.filter((e=>e.isEditable())),this.args,this.plainTitle,this.state.editable,e,(e=>this.updateArguments(e)),this)},showInfo(){this.collectionId?this.$parent.$emit("showCollection",this.collectionId):this.isParameter?this.$parent.$emit("showParameter",this.spec):this.$parent.$emit("showProcess",this.processId,this.namespace)},async addDescription(){this.select(),this.showDescriptionField=!0,await this.$nextTick(),this.$refs.descriptionField.focus()},async emitDrag(e){this.select(!0,!e.shiftKey),this.focus(),await this.$nextTick(),this.$emit("move",e)},getDragPos(e,t){return[t[0]/this.state.scale-e[0],t[1]/this.state.scale-e[1]]},startDrag(e){if(!this.selected)return;let t=this.$parent.getMousePos(e);this.drag={origin:this.position,mouse:this.getDragPos(this.position,t)}},stopDrag(){if(this.drag){var e=5/this.state.scale;(Math.abs(this.drag.origin[0]-this.position[0])>e||Math.abs(this.drag.origin[1]-this.position[1])>e)&&this.updatePosition(this.position),this.drag=null}},dragging(e){if(!this.drag)return;let t=this.$parent.getMousePos(e),s=this.getDragPos(this.drag.mouse,t);this.updatePosition(s,!1)},hasOutputEdges(){return this.$refs.output&&this.$refs.output.getEdgeCount()>0},async remove(){await this.$parent.removeBlock(this)},getBlockParameter(e){if("output"===e&&this.$refs.output)return this.$refs.output;if(Array.isArray(this.$refs.parameters)){var t=this.$refs.parameters.filter((t=>t.name===e));if(t.length>0)return t[0]}return null},isParameterScoped(e,t){let s=this.getBlockParameter(e),i=h.ProcessUtils.getCallbackParameters(s).map((e=>e.name));return i.includes(t)},hiddenParameterRef(e){if("process"!==this.type)return null;let t=e.id.substr(1);for(let s in this.args){let e=this.args[s];if(u.Z.isObject(e)&&u.Z.isObject(e.process_graph)){let i=c.Utils.getRefs(e,!0,!0);if(i.find((e=>e.from_parameter===t&&!this.isParameterScoped(s,e.from_parameter))))return s}}return null}}},w=k;var P=(0,f.Z)(w,a,o,!1,null,null,null);const $=P.exports;var E=function(){var e=this,t=e._self._c;return t("g",e._l(e.lines,(function(s,i){return t("line",e._b({key:i},"line",s,!1))})),0)},x=[];class B{constructor(e,t,s,i){this.x=e,this.y=t,this.dx=s,this.dy=i}distance(e,t){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}distanceP(e){var t=this.normal();t.x=e.x,t.y=e.y;var s=this.intersection(t);return[s[0],this.distance(t.alpha(s[1]),e)]}normal(){return new B(this.x,this.y,this.dy,-this.dx)}intersection(e){var t=this.dx,s=-e.dx,i=this.dy,r=-e.dy,a=e.x-this.x,o=e.y-this.y,n=t*r-s*i;if(0==n)return null;var l=(r*a-s*o)/n,h=(-i*a+t*o)/n;return[l,h]}alpha(e){var t={};return t.x=this.x+this.dx*e,t.y=this.y+this.dy*e,t}}const _={name:"Edge",props:{id:{},parameter1:{type:Object,required:!0},parameter2:{type:Object,required:!0},selected:{type:Boolean,default:!1},inactive:{type:Boolean,default:!1},issues:{type:Array,default:()=>[]},lineWidth:{type:Number,default:3},lineColor:{type:Array,default:()=>[255,200,0,1]},state:{type:Object,required:!0}},data(){return{position1:null,position2:null}},computed:{segment(){return new B(this.position1[0],this.position1[1],this.position2[0]-this.position1[0],this.position2[1]-this.position1[1])},scaledLineWidth(){return this.lineWidth*this.state.scale},lines(){var e=(this.position1[0]+this.position2[0])/2,t=(this.position1[1]+this.position2[1])/2,s=35*Math.PI/180,i=Math.cos(s),r=Math.sin(s),a=Math.cos(-s),o=Math.sin(-s),n=Math.sqrt(Math.pow(this.position1[0]-this.position2[0],2)+Math.pow(this.position1[1]-this.position2[1],2)),l=10*this.state.scale/(n/1.5),h=(this.position1[0]-e)*l,c=(this.position1[1]-t)*l,u=this.getLineStyle(this.scaledLineWidth,this.selected,this.inactive),p=this.getLineStyle(this.scaledLineWidth/1.5,this.selected),d=this.getLine(this.position1[0],this.position1[1],this.position2[0],this.position2[1],u);return this.inactive||n/this.state.scale<25?[d]:[d,this.getLine(e,t,e+(h*i-c*r),t+(c*i+h*r),p),this.getLine(e,t,e+(h*a-c*o),t+(c*a+h*o),p)]}},watch:{"state.center"(){this.updatePositions()},"state.scale"(){this.updatePositions()},"state.moving"(){this.updatePositions()}},created(){this.updatePositions()},mounted(){this.$emit("mounted",this)},beforeDestroy(){this.$emit("unmounted",this)},methods:{updatePositions(){let e=this.parameter1.getCirclePosition(),t=this.parameter2.getCirclePosition();e&&t&&(this.position1&&this.position2&&e[0]===this.position1[0]&&e[1]===this.position1[1]&&t[0]===this.position2[0]&&t[1]===this.position2[1]||(this.position1=Object.freeze(e),this.position2=Object.freeze(t),this.$emit("position",this.position1,this.position2)))},getLineStyle(e,t=!1,s=!1){let i=2*this.state.scale,r=this.lineColor;return t?r=[0,200,0,1]:this.issues.length>0&&(r=[255,0,0,1]),{stroke:`rgba(${r.join(", ")})`,"stroke-width":e,"stroke-dasharray":s?3*i+" "+2*i:"none"}},getLine(e,t,s,i,r={}){return Object.assign({x1:e,y1:t,x2:s,y2:i},r)},collide(e,t){if(!this.segment)return!1;var s=this.segment.distanceP({x:e,y:t});return s[0]>=0&&s[0]<=1&&s[1]<this.lineWidth*this.state.scale*2&&s[0]},equals(e){return this.parameter1==e.parameter1&&this.parameter2==e.parameter2||this.parameter1==e.parameter2&&this.parameter2==e.parameter1}}},M=_;var S=(0,f.Z)(M,E,x,!1,null,null,null);const D=S.exports;var O=s(20144),C=s(11658),R=s.n(C),A=s(59322),Z=s.n(A),j=s(25108);const T=function(e){return O.ZP.observable({root:e,editable:!1,compactMode:!1,moving:null,selecting:null,center:[0,0],mouse:[0,0],scale:v.defaultScale,linkFrom:null,linkTo:null})},I=20,V=function(e,t){Array.isArray(e)&&Array.isArray(t)&&e.length===t.length&&e.every(((e,s)=>e.id===t[s].id))||this.$emit("selectionChanged",this.selectedBlocks,this.selectedEdges)},F={name:"ModelBuilder",components:{Block:$,Edge:D,ParameterViewer:()=>s.e(1871).then(s.bind(s,81871))},props:{id:{type:String,required:!0},editable:{type:Boolean,default:!1},value:{type:Object,default:()=>({})},collections:{type:Array,default:()=>[]},processes:{type:[Array,Object],default:()=>[]},parent:{type:Object,default:null},parentSchema:{type:Object,default:null},historySize:{type:Number,default:30},explicitZoom:{type:Boolean,default:!1}},data(){return{isMounted:!1,allMounted:!1,newBlockOffset:0,history:[],historyPointer:null,process:Object.freeze(this.value),blocks:[],edges:[],hiddenParameterRefEdges:{},processGraph:null,nextBlockId:1,nextEdgeId:1,clipboard:null,activeTransactions:0,hasFocus:!1,linkingLine:null,parameterViewer:null,showZoomInfo:this.explicitZoom,state:T(this)}},computed:{classes(){let e=["vue-component","model-builder"];return this.hasFocus&&e.push("focus"),this.editable&&e.push("editable"),this.state.compactMode&&e.push("compact"),this.state.scale<.5?e.push("scale_xs"):this.state.scale<.7?e.push("scale_s"):this.state.scale<.9?e.push("scale_m"):this.state.scale<1.1?e.push("scale_l"):e.push("scale_xl"),e},selectRect(){return this.state.selecting?{x:Math.min(this.state.selecting.current[0],this.state.selecting.start[0]),y:Math.min(this.state.selecting.current[1],this.state.selecting.start[1]),width:Math.abs(this.state.selecting.current[0]-this.state.selecting.start[0]),height:Math.abs(this.state.selecting.current[1]-this.state.selecting.start[1]),stroke:"rgba(0,0,0,0.8)","stroke-width":1,fill:"rgba(0,0,0,0.05)"}:null},processRegistry(){if(this.processes instanceof h.ProcessRegistry||"function"===typeof this.processes.count&&"function"===typeof this.processes.get)return this.processes;if(Array.isArray(this.processes))return new h.ProcessRegistry(this.processes);throw new Error("Invalid processes specified, must be ProcessRegistry or Array")},hasProcesses(){return this.processRegistry.count()>0},processBlocks(){return this.blocks.filter((e=>"process"===e.type))},selectedBlocks(){return this.blocks.filter((e=>e.selected))},selectedEdges(){return this.edges.filter((e=>e.selected))},selectedSideEdge(){return 1===this.selectedEdges.length&&this.selectedEdges[0].selectedParameter?this.selectedEdges[0]:null},hasSelection(){return this.selectedBlocks.length>0||this.selectedEdges.length>0},processParametersFromSchemas(){let e=[];this.parent&&this.parent.$parent&&"function"===typeof this.parent.$parent.getPgParameters&&(e=this.parent.$parent.getPgParameters().map((e=>e.spec)));let t=[];this.parentSchema&&(t=this.parentSchema.getCallbackParameters());let s=e.filter((e=>!t.find((t=>e.name===t.name))));return t.concat(s)}},watch:{parentSchema(){this.importPgParameters(this.processParametersFromSchemas,"schema")},async value(e){this.allMounted&&(e instanceof N||(this.process=e,await this.import(e,{propagate:!1,undoOnError:!1})))},editable:{immediate:!0,handler(e){this.state.editable=e}},selectedEdges:V,selectedBlocks:V,allMounted(){this.updateHiddenParameterRefEdges()},isMounted(){this.checkAllMounted()}},beforeCreate(){u.Z.enableHtmlProps(this)},async created(){this.supports("error")||this.$on("error",((e,t=null)=>j.error(e,t))),this.supports("editArguments")||this.$on("editArguments",((...e)=>this.showParameterViewer(...e)))},async mounted(){u.Z.loadFontAwesome(this),this.moveCenter(0,0,!0),this.onDocumentMouseUpFn=this.onDocumentMouseUp.bind(this),document.addEventListener("mouseup",this.onDocumentMouseUpFn),await this.importPgParameters(this.processParametersFromSchemas,"schema"),await this.import(this.value,{propagate:!1,undoOnError:!1})||this.perfectScale(),V.bind(this)(),this.isMounted=!0},beforeDestroy(){document.removeEventListener("mouseup",this.onDocumentMouseUpFn)},methods:{updateEdgePos(e,t){e.position1=t[0],e.position2=t[1]},mount(e,t=null){e.$el=t,this.checkAllMounted()},checkAllMounted(){this.isMounted?this.allMounted=!this.blocks.find((e=>!e.$el))||!this.edges.find((e=>!e.$el)):this.allMounted=!1},updateBlockArguments(e,t,s){s.length>0&&this.parameterRemoved(e,s),this.$set(e,"arguments",t),this.commit(),s.length>0&&this.$nextTick((()=>this.refreshEdges()))},updateBlockDescription(e,t){this.$set(e,"description",t),this.commit()},updateBlockPos(e,t,s=!0){this.$set(e,"position",t),this.commit(null,s,!1)},updateBlockResult(e,t){this.$set(e,"result",t),this.commit()},updateBlockSelected(e,t,s=!0){s&&this.unselectAll(),this.$set(e,"selected",t),this.commit(null,!1,!1)},updateBlockSpec(e,t){let s=["name","schema","description","optional","deprecated","experimental","default"],i=u.Z.omitFromObject(e.spec,s);Object.assign(i,t),i.optional||(delete i.optional,delete i.default),i.deprecated||delete i.deprecated,i.experimental||delete i.experimental,this.$set(e,"spec",i),this.commit()},updateBlock(e,t,s,i){switch(t){case"arguments":this.updateBlockArguments(e,s,i);break;case"description":this.updateBlockDescription(e,s);break;case"position":this.updateBlockPos(e,s,i);break;case"result":this.setResultNode(e,s);break;case"selected":this.updateBlockSelected(e,s,i);break;case"spec":this.updateBlockSpec(e,s);break}},updateHiddenParameterRefEdges(){if(!this.hasProcesses||!this.allMounted||!this.blocks.find((e=>"parameter"===e.type)))return void(this.hiddenParameterRefEdges={});let e={};for(let s of this.processBlocks)for(let i in s.arguments){let r=s.arguments[i];if(!u.Z.isObject(r)||!u.Z.isObject(r.process_graph))continue;let a=c.Utils.getRefs(r,!0,!0).filter((e=>"undefined"!==typeof e.from_parameter));for(let o of a)try{if(s.$el.isParameterScoped(i,o.from_parameter))continue;let t=this.getPgParameterById("$"+o.from_parameter);if(!t)continue;let r=t.$el.getBlockParameter("output"),a=s.$el.getBlockParameter(i),n=`${t.id}->${s.id}:${i}`;r&&a&&(this.hiddenParameterRefEdges[n]?e[n]=this.hiddenParameterRefEdges[n]:e[n]={$el:null,id:n,parameter1:r,parameter2:a})}catch(t){j.warn(t)}}this.hiddenParameterRefEdges=e},parameterRemoved(e,t){for(let s of this.edges.slice(0))s.parameter2.$parent.id===e.id&&t.includes(s.parameter2.name)&&this.removeEdge(s)},startDragBlock(e){for(let t of this.blocks)t.$el&&t.$el.startDrag(e)},refreshEdges(){this.refreshEdgesFor(this.edges),this.refreshEdgesFor(Object.values(this.hiddenParameterRefEdges))},refreshEdgesFor(e){for(let t of e)t.$el&&t.$el.updatePositions()},supports(e){return Boolean(this.$listeners&&this.$listeners[e])},focus(){this.$refs.div.focus()},link(e){this.state.linkFrom?this.state.linkTo=e:this.state.linkFrom=e},unlink(e=null){e?this.state.linkTo==e?this.state.linkTo=null:this.state.linkFrom==e&&(this.state.linkFrom=null,this.linkingLine=null):(this.state.linkTo=null,this.state.linkFrom=null,this.linkingLine=null)},multiSelect(){let e=this.selectRect;this.blocks.filter((t=>{if(Array.isArray(t.position)&&t.$el){let s=t.$el.getDimensions();return R()(e.x,e.y,e.width,e.height,s.x,s.y,s.width,s.height)}return!1})).map((e=>e.selected=!0)),this.edges.filter((t=>Array.isArray(t.position1)&&Array.isArray(t.position2)&&Z()(e.x,e.y,e.width,e.height,t.position1[0],t.position1[1],t.position2[0],t.position2[1]))).map((e=>e.selected=!0))},toJSON(){let e=this.export();return JSON.stringify(e,null,2)},async onDocumentMouseUp(e){if(!this.parameterViewer&&(this.selectedSideEdge&&this.selectEdge(this.selectedSideEdge,null),this.state.selecting&&(this.multiSelect(),this.state.selecting=null),this.state.moving&&(this.state.moving=null),this.state.editable&&this.state.linkFrom)){if(1==e.which&&this.state.linkTo)try{await this.addEdge(this.state.linkFrom,this.state.linkTo)}catch(t){this.$emit("error",t)}this.unlink()}},async onKeyDown(e){if(this.parameterViewer)return;var t=document.querySelectorAll("input, textarea, button, select, datalist");for(let r of t)if(r===document.activeElement)return;let s=!1;if(this.state.editable)if("Delete"===e.code)this.deleteSelected(),s=!0;else if(e.ctrlKey||e.metaKey)if("KeyV"===e.code){if(this.hasSelection&&this.clipboard)return;try{const e=await navigator.clipboard.readText();let t=JSON.parse(e);await this.import(t)}catch(i){this.$emit("error",i,"Paste Error")}s=!0}else if("KeyC"===e.code){if(this.hasSelection)this.clipboard={blocks:this.selectedBlocks.slice(0),edges:this.selectedEdges.slice(0)};else try{let e=this.toJSON();await navigator.clipboard.writeText(e),s=!0}catch(i){this.$emit("error",i,"Copy Error")}s=!0}s&&(e.preventDefault(),e.stopPropagation())},onMouseWheel(e){if(!this.parameterViewer&&(!this.explicitZoom||this.hasFocus||e.ctrlKey||e.metaKey)){let r=this.getMousePos(e);var t=r[0]-this.state.center[0],s=r[1]-this.state.center[1],i=Math.pow(1.1,-1*Math.sign(e.deltaY));this.moveCenter(-t*(i-1),-s*(i-1)),this.state.scale*=i,e.preventDefault(),this.showZoomInfo=!1}},domBoundingBox(e){var t=e.getBoundingClientRect();return t.offsetTop=t.top+Math.max(document.documentElement.scrollTop,document.body.scrollTop),t.offsetLeft=t.left+Math.max(document.documentElement.scrollLeft,document.body.scrollLeft),t},getMousePos(e){let t=this.$refs.div.getBoundingClientRect();return[e.clientX-t.left,e.clientY-t.top]},onMouseMove(e){if(!this.parameterViewer)try{let r=this.getMousePos(e);if(this.state.editable&&this.selectedSideEdge){var t=this.selectedSideEdge.selectedParameter.getCirclePosition();if(t){var s=Math.sqrt(Math.pow(r[0]-t[0],2)+Math.pow(r[1]-t[1],2));s>10&&(this.link(this.selectedSideEdge.selectedParameter),this.removeEdge(this.selectedSideEdge),this.commit())}}if(this.state.selecting&&(this.state.selecting.current=r),this.state.moving&&(this.moveCenter(r[0]-this.state.moving[0],r[1]-this.state.moving[1]),this.state.moving=r),this.state.linkFrom){var i=this.state.linkFrom.getCirclePosition();i&&(this.linkingLine={x1:i[0],y1:i[1],x2:r[0],y2:r[1],stroke:"rgba(0,0,0,0.4)","stroke-width":3*this.state.scale})}}catch(r){this.$emit("error",r)}},onMouseDown(e){if(this.parameterViewer)return;let t=null,s=this.getMousePos(e);if(1==e.which)for(var i of(e.shiftKey?this.state.selecting={start:s,current:s}:this.unselectAll(),this.edges))if(i.$el){var r=i.$el.collide(s[0],s[1]);if(0!=r){if(0!==this.selectedEdges.length||e.shiftKey||(r<.3?t=i.parameter2:r>.7&&(t=i.parameter1)),this.selectEdge(i,!0,t),i.issues.length>0)for(let e of i.issues)this.$emit("error",e);e.preventDefault();break}}2!=e.which&&(1!=e.which||t||e.shiftKey)||(this.state.moving=s),this.focus()},getDimensions(){return this.domBoundingBox(this.$refs.div)},async clear(){return await this.startTransaction((async()=>(this.edges=[],this.blocks=this.blocks.filter((e=>"parameter"===e.type&&u.Z.isObject(e.spec)&&"schema"===e.origin)),this.nextBlockId=1,this.nextEdgeId=1,this.process={},this.updateHiddenParameterRefEdges(),!0)))},commit(e=null,t=!0,s=!0){this.activeTransactions>0||(!1!==t&&this.saveHistory(),!1!==s?(this.$emit("input",null===e?this.export():e),this.updateHiddenParameterRefEdges()):this.refreshEdges())},saveHistory(){var e=this.export(!0);this.history.splice(this.historyPointer+1,this.historySize,Object.freeze(e)),this.history.length>this.historySize&&this.history.shift(),this.historyPointer=this.history.length-1,this.$emit("historyChanged",this.history,this.historyPointer)},async undo(){await this.historyStep(-1)},async redo(){await this.historyStep(1)},async historyStep(e){var t=this.historyPointer+e,s=this.history[t];s&&(this.historyPointer=t,this.import(s,{saveHistory:!1,undoOnError:!1,perfectScale:!1}),this.$emit("historyChanged",this.history,this.historyPointer))},setResultNode(e,t=!0){if(e=this.getBlockById(e.id),e&&e.result!==t){this.updateBlockResult(e,t);var s=!1,i=!1;for(var r of this.processBlocks)if(!e||r.id!==e.id)if(i=!0,t)this.updateBlockResult(r,!1);else if(r.$el&&!r.$el.hasOutputEdges()){this.updateBlockResult(r,!0),s=!0;break}!i||t||s||this.$emit("error","No result node available, please specify one.")}},getPositionForPageXY(e,t){var s=this.getDimensions();return null!==e&&(e=(e-s.offsetLeft-this.state.center[0])/this.state.scale),null!==t&&(t=(t-s.offsetTop-this.state.center[1])/this.state.scale),[e,t]},addProcess(e,t={},s=[],i=null){return this.addBlock({process_id:e,namespace:i,arguments:t,position:s})},addBlock(e,t=null){let s=String(this.incrementId(t));null===t&&u.Z.hasText(e.process_id)?(t=e.process_id.replace(/^([a-z]*).*$/i,"$1")+s,this.getBlockById("#"+t)&&(t=s)):t=s,"function"===typeof e.toJSON&&(e=e.toJSON());var i={id:"#"+t,type:"process",selected:!1,position:e.position,process_id:e.process_id,namespace:e.namespace,arguments:e.arguments,description:e.description||null,result:e.result||!1};this.processRegistry&&(i.spec=this.processRegistry.get(e.process_id,e.namespace));var r=this.getBlockSize(i);return i.position=u.Z.ensurePoint(i.position,(()=>this.getNewBlockDefaultPosition(r))),i.result&&this.blocks.filter((e=>!0===e.result)).length?delete i.result:0===this.processBlocks.length&&(i.result=!0),this.blocks.push(O.ZP.observable(i)),this.commit(),i},getNewBlockDefaultPosition(e){var t=this.getDimensions(),s=[(-this.state.center[0]+t.width/2)/this.state.scale-e[0]/2+this.newBlockOffset,(-this.state.center[1]+t.height/2)/this.state.scale-e[1]/2+this.newBlockOffset];return this.newBlockOffset<150&&(this.newBlockOffset+=10),s},getBlockSize(e){if(e.$el){let t=e.$el.getDimensions();return[t.width/this.state.scale,t.height/this.state.scale]}let t,s=Math.max(u.Z.size(e.arguments),u.Z.isObject(e.spec)?u.Z.size(e.spec.parameters):0),i=v.blockWidth;t=s>0?this.state.compactMode?i.compactParams:i.normalParams:this.state.compactMode?i.compact:i.normal;let r="string"===typeof e.description?40:0,a=I+15*s+r;return[t,a]},moveCenter(e,t,s=!1){var i=this.getDimensions();this.state.center=[(s?i.width/2:this.state.center[0])+e,(s?i.height/2:this.state.center[1])+t],this.newBlockOffset=0},unselectAll(){for(var e of this.blocks)this.updateBlockSelected(e,!1,!1);for(var t of this.edges)this.selectEdge(t,!1)},selectEdge(e,t=!0,s=null){return u.Z.isObject(e)||(e=this.edges[e]),e.selected!==t&&(null!==t&&this.$set(e,"selected",t),this.$set(e,"selectedParameter",s),!0)},removeEdge(e){e.parameter1.eraseEdge(e),e.parameter2.eraseEdge(e),this.$delete(this.edges,this.edges.indexOf(e))},async removeBlock(e){if("parameter"===e.type){let t=null,s=this.blocks.find((s=>(t=s.$el.hiddenParameterRef(e),null!==t)));if(s)throw new Error(`Parameter is still used in '${s.id}', parameter '${t}'. Only unused parameters can be deleted.`)}return await this.startTransaction((async()=>{var t=this.blocks.findIndex((t=>t.id==e.id));if(t<0)return!1;for(var s of this.edges.slice(0))s.parameter1.$parent.id!==e.id&&s.parameter2.$parent.id!==e.id||this.removeEdge(s);return e.result&&this.setResultNode(e,!1),this.$delete(this.blocks,t),!0}))},getBlockById(e){var t=this.blocks.filter((t=>t.id===e));return t.length>0?t[0]:null},async deleteSelected(){return!!this.hasSelection&&await this.startTransaction((async()=>{for(var e of this.selectedBlocks.slice(0))e.$el.allowsDelete&&await this.removeBlock(e);for(var t of this.selectedEdges.slice(0))this.removeEdge(t);return!0}))},async addEdgeByNames(e,t,s,i){var r=[];for(var a of[e,s]){var o=this.getBlockById(a);if(!o)throw"Can't find block: "+a;if(!o.$el)throw"Block not mounted yet: "+a;r.push(o.$el)}await this.addEdge(r[0].getBlockParameter(t),r[1].getBlockParameter(i))},async addEdge(e,t){if(!e||!t)throw"One of the parameters is invalid.";if(e!=t){if(e.$parent==t.$parent)throw"You can't link a block to itself";var s=this.nextEdgeId++,i={id:s,selected:!1,inactive:!1,issues:[],$el:null};if(e.output?(i.parameter1=e,i.parameter2=t):(i.parameter1=t,i.parameter2=e),i.parameter1.output===i.parameter2.output)throw"You have to link an input with an output";if(-1!==this.allSuccessors(i.parameter1).indexOf(i.parameter2.id))throw"You can not create a loop";if(i.parameter2.getEdgeCount()>0&&!i.parameter2.allowsMultipleInputs)throw"Parameter accepts only one input";for(var r of this.edges)if(r.$el&&r.$el.equals(i))throw"This connection exists already";if(!c.JsonSchemaValidator.isSchemaCompatible(i.parameter2.schema||{},i.parameter1.schema||{},!1,!0)){let e='Incoming data type is not compatible for parameter "'+i.parameter2.name+'"';i.issues.push(e),this.$emit("error",e)}return await this.startTransaction((async()=>(this.unlink(),this.edges.push(O.ZP.observable(i)),i.parameter1.addEdge(i),i.parameter2.addEdge(i),this.setResultNode(i.parameter1.$parent,!1),!0)))}},allSuccessors(e){var t=e.$parent,s={},i=[t];s[t.id]=!0;while(i.length>0){var r=i.pop();for(var a in r.edges)for(var o in r.edges[a]){var n=r.edges[a][o];if(n.block1==r){var l=n.block2;l.id in s||(s[l.id]=!0,i.push(l))}}}return Object.values(s)},async toggleCompact(){this.state.compactMode=!this.state.compactMode,this.$emit("compactMode",this.state.compactMode),await this.$nextTick(),this.refreshEdges()},export(e=!1){let t={process_graph:{}};for(let s of this.processBlocks){let i=["process_id","namespace","arguments","description","result"];e&&i.push("position");let r=u.Z.pickFromObject(s,i);null===r.description&&delete r.description,!0!==r.result&&delete r.result,r.namespace||delete r.namespace;let a=s.id.substr(1);t.process_graph[a]=r}if(!this.parent){t.parameters=[];let e=this.getPgParameters();for(let s of e)t.parameters.push(s.spec)}return new N(Object.assign({},this.process,t))},async startTransaction(e,t={},...s){let i;this.activeTransactions++;try{i=await e(s)}catch(r){if(this.$emit("error",r,"Model is invalid"),!1!==t.undoOnError)try{await this.undo()}catch(a){this.$emit("error",r,"Revert failed")}i=!1}return this.activeTransactions--,this.commit(null,t.saveHistory,t.propagate),i},async import(e,t={}){return await this.startTransaction((async()=>{if(!1!==t.clear&&(await this.clear(),this.process=e instanceof c.ProcessGraph?e.toJSON():e),!u.Z.isObject(e))return!1;let s;return e instanceof c.ProcessGraph?(s=new c.ProcessGraph(e.toJSON(),this.processRegistry),s.setParent(e.parentProcessId,e.parentParameterName)):s=new c.ProcessGraph(e,this.processRegistry),s.allowEmpty(),s.parse(),this.processGraph=Object.freeze(s),await this.importPgParameters(this.processGraph.getProcessParameters(!0),"user",!1!==t.clear),await this.importNodes(this.processGraph.getStartNodes()),await this.importEdges(this.processGraph),!1!==t.perfectScale&&this.perfectScale(),this.$nextTick((()=>this.updateHiddenParameterRefEdges())),!0}),t)},async importPgParameters(e,t,s=!0){if(!Array.isArray(e))return;let i={undoOnError:!1,saveHistory:!1,propagate:!1};return await this.startTransaction((async()=>{s&&(this.blocks=this.blocks.filter((e=>"parameter"!==e.type||e.origin!==t)));let i=this.getBlockSize({}),r=[0,0];for(var a in e)r=[-i[0]-I,a*(i[1]+I)],await this.addPgParameter(e[a],t,r)}),i)},async addPgParameter(e,t="user",s=null){return await this.startTransaction((async()=>{let i="$"+e.name;return!(this.blocks.findIndex((e=>"parameter"===e.type&&e.id==i))>=0)&&(e=u.Z.deepClone(e),"undefined"===typeof e.schema&&(e.schema={}),this.blocks.push(O.ZP.observable({id:i,type:"parameter",origin:t,position:u.Z.ensurePoint(s,(()=>this.getNewBlockDefaultPosition(this.getBlockSize({})))),spec:Object.freeze(e)})),!0)}))},getPgParameters(){return this.blocks.filter((e=>"parameter"===e.type))},getPgParameterById(e){return this.blocks.find((t=>"parameter"===t.type&&t.id===e))},async importEdges(e){var t=e.getNodes();for(var s of Object.values(t)){var i=s.getArgumentNames();for(let t in i){var r=s.getRawArgument(i[t]);switch(s.getArgumentType(i[t])){case"result":await this.addEdgeByNames("#"+e.getNode(r.from_node).id,"output","#"+s.id,i[t],!1);break;case"parameter":await this.addEdgeByNames("$"+r.from_parameter,"output","#"+s.id,i[t],!1);break;case"object":case"array":await this.importEdgeDeep(r,e,s,i,t);break}}}},async importEdgeDeep(e,t,s,i,r){for(let a in e)if(e[a]&&"object"===typeof e[a]&&"process_graph"!==a)await this.importEdgeDeep(e[a],t,s,i,r);else{if(!u.Z.isRef(e))continue;e.from_node?await this.addEdgeByNames("#"+t.getNode(e.from_node).id,"output","#"+s.id,i[r],!1):e.from_parameter&&await this.addEdgeByNames("$"+e.from_parameter,"output","#"+s.id,i[r],!1)}},async importNodes(e,t=0,s=0,i=[]){let r=[],a=0;for(let o of e){if(i.includes(o.id)||void 0!==o.getPreviousNodes().find((e=>!i.includes(e.id)))){s+=I/2;continue}let e="function"===typeof o.toJSON?o.toJSON():o;e.position=u.Z.ensurePoint(e.position,(()=>[t,s]));let n=this.addBlock(e,o.id);i.push(o.id);let l=this.getBlockSize(n);a=Math.max(a,e.position[0]+l[0]),s=e.position[1]+l[1]+I,r=r.concat(o.getNextNodes())}r.length&&await this.importNodes(r,a+I,0,i)},incrementId(e=null){"number"===typeof e||"string"===typeof e&&0!==e.length||(e=this.nextBlockId,this.nextBlockId++);let t=Number.parseInt(e,10);return Number.isNaN(t)||(this.nextBlockId=Math.max(this.nextBlockId,t+1)),e},perfectScale(){if(this.$refs.div&&0!==this.blocks.length){var e=null,t=null,s=null,i=null;for(let r of this.blocks){let a=this.getBlockSize(r),o=u.Z.ensurePoint(r.position);null==e?(e=o[0]-15,t=o[0]+a[0]+15,s=o[1]-15,i=o[1]+a[1]+15):(e=Math.min(e,o[0]-15),t=Math.max(t,o[0]+a[0]+15),s=Math.min(s,o[1]-15),i=Math.max(i,o[1]+a[1]+15))}var r=this.$refs.div.getBoundingClientRect(),a=r.width/(t-e),o=r.height/(i-s);this.state.scale=Math.min(a,o,1.5),this.state.center=[r.width/2-this.state.scale*(e+t)/2,r.height/2-this.state.scale*(s+i)/2],this.newBlockOffset=0}},showParameterViewer(e,t,s,i,r,a,o){this.parameterViewer={parameters:e,values:t,title:s,selectParameterName:r,parent:o}}}};class N{constructor(e){Object.assign(this,e)}}const L=F;var q=(0,f.Z)(L,i,r,!1,null,null,null);const z=q.exports},11658:e=>{"use strict";e.exports=function(e,t,s,i,r,a,o,n){return e<r+o&&e+s>r&&t<a+n&&t+i>a}},59322:(e,t,s)=>{"use strict";var i=s(30741);e.exports=function(e,t,s,r,a,o,n,l){return i(a,o,n,l,e,t,s,r)}},92239:e=>{"use strict";e.exports=function(e,t,s,i,r,a){return r>=e&&r<=e+s&&a>=t&&a<=t+i}},30741:(e,t,s)=>{"use strict";var i=s(92239),r=s(22203);e.exports=function(e,t,s,a,o,n,l,h){return!(!i(o,n,l,h,e,t)&&!i(o,n,l,h,s,a))||(r(e,t,s,a,o,n,o+l,n)||r(e,t,s,a,o+l,n,o+l,n+h)||r(e,t,s,a,o,n+h,o+l,n+h)||r(e,t,s,a,o,n,o,n+h))}},22203:(e,t,s)=>{"use strict";const i=s(93086),r=s(19887),a=s(71648),o=s(50142);function n(e,t,s,o,n,l,h,c,u,p){return u&&p?r(i(e,t,s,o,u),i(n,l,h,c,p)):u?a(n,l,h,c,i(e,t,s,o,u)):p?a(e,t,s,o,i(n,l,h,c,u)):void 0}e.exports=function(e,t,s,i,r,a,l,h,c,u){return c||u?n(e,t,s,i,r,a,l,h,c,u):o(e,t,s,i,r,a,l,h)}},68116:e=>{"use strict";function t(e,t,s,i){return Math.sqrt(Math.pow(e-s,2)+Math.pow(t-i,2))}e.exports=function(e,s,i,r,a,o,n){return n=n||1,Math.abs(t(e,s,i,r)-(t(e,s,a,o)+t(i,r,a,o)))<=n}},71648:(e,t,s)=>{var i=s(64815),r=s(50142);e.exports=function(e,t,s,a,o,n){var l=o.length;if(i(o,e,t,n))return!0;for(var h=0;h<l;h+=2){var c=(h+2)%l;if(r(e,t,s,a,o[h],o[h+1],o[c],o[c+1]))return!0}return!1}},50142:e=>{"use strict";e.exports=function(e,t,s,i,r,a,o,n){var l=s-e,h=i-t,c=o-r,u=n-a,p=(-h*(e-r)+l*(t-a))/(-c*h+l*u),d=(c*(t-a)-u*(e-r))/(-c*h+l*u);return p>=0&&p<=1&&d>=0&&d<=1}},93086:e=>{"use strict";e.exports=function(e,t,s,i,r){const a=Math.atan2(i-t,s-e)-Math.PI/2,o=r/2,n=Math.cos(a)*o,l=Math.sin(a)*o;return[e-n,t-l,s-n,i-l,s+n,i+l,e+n,t+l]}},64815:(e,t,s)=>{"use strict";const i=s(68116);e.exports=function(e,t,s,r){var a,o,n=e.length,l=!1;for(a=0,o=n-2;a<n;a+=2)e[a+1]>s!==e[o+1]>s&&t<(e[o]-e[a])*(s-e[a+1])/(e[o+1]-e[a+1])+e[a]&&(l=!l),o=a;if(l)return!0;for(a=0;a<n;a+=2){var h,c,u=e[a],p=e[a+1];if(a===n-2?(h=e[0],c=e[1]):(h=e[a+2],c=e[a+3]),i(u,p,h,c,t,s,r))return!0}return!1}},19887:e=>{"use strict";e.exports=function(e,t){for(var s,i,r,a,o,n,l=e,h=t,c=[l,h],u=0;u<c.length;u++)for(var p=c[u],d=0;d<p.length;d+=2){var m=(d+2)%p.length,f={x:p[m+1]-p[d+1],y:p[d]-p[m]};for(s=i=null,n=0;n<l.length;n+=2)r=f.x*l[n]+f.y*l[n+1],(null===s||r<s)&&(s=r),(null===i||r>i)&&(i=r);for(a=o=null,n=0;n<h.length;n+=2)r=f.x*h[n]+f.y*h[n+1],(null===a||r<a)&&(a=r),(null===o||r>o)&&(o=r);if(i<a||o<s)return!1}return!0}}}]);
//# sourceMappingURL=8945.32307f9a.js.map